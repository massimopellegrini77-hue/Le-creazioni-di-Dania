<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Riepilogo Ordini — Le creazioni di Dania</title>
  <meta name="description" content="Pagina carrello e riepilogo ordini con pagamento PayPal e Satispay. Supporto galleria immagini per articolo." />
  <link rel="icon" href="logo.jpg" type="image/jpeg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root{--maxw:1100px;--c1:#222;--c2:#555;--brand:#c24d3c;--brand2:#ffe6dc;--bg:#faf8fb}
    *{box-sizing:border-box}
    body{margin:0;font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;color:var(--c1);background:var(--bg)}
    a{color:var(--brand);text-decoration:none}
    img{max-width:100%;display:block}
    header{position:sticky;top:0;background:#fff7;backdrop-filter:saturate(150%) blur(10px);border-bottom:1px solid #eee;z-index:10}
    .wrap{max-width:var(--maxw);margin:0 auto;padding:0 16px}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 0}
    .brand{display:flex;gap:10px;align-items:center}
    nav ul{display:flex;gap:18px;list-style:none;margin:0;padding:0}
    nav a{color:var(--c1);font-weight:500}
    .btn{display:inline-block;padding:10px 16px;border-radius:10px;border:1px solid var(--brand);color:white;background:var(--brand);transition:.2s}
    .btn:hover{filter:brightness(0.95)}
    .btn.satispay{background:#e53b3b;border-color:#e53b3b;color:#fff}
    .btn.outline{background:transparent;color:var(--brand)}
    .hero{display:grid;grid-template-columns:1.1fr 0.9fr;gap:24px;align-items:center;padding:28px 0}
    .hero h1{font-size:clamp(28px,3.6vw,42px);margin:0 0 8px;color:var(--brand)}
    .hero p{color:var(--c2);margin:0 0 16px}
    .badge{display:inline-block;background:var(--brand2);color:var(--brand);padding:6px 10px;border-radius:999px;font-size:12px;margin-bottom:8px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
    .card{background:#fff;border:1px solid #eee;border-radius:16px;overflow:hidden;display:flex;flex-direction:column}
    .card .body{padding:14px;display:flex;flex:1;flex-direction:column;gap:8px}
    .price{font-weight:700;color:var(--brand)}
    .pill{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;background:#f6f3f9;color:#7b5d84}
    .section{padding:28px 0}
    .section h2{margin:0 0 8px;color:var(--brand)}
    .muted{color:var(--c2)}
    .banner{background:linear-gradient(135deg,#fff,#f7ecff);border:1px solid #eee;padding:18px;border-radius:16px}
    footer{border-top:1px solid #eee;margin-top:28px}
    .footercols{display:grid;grid-template-columns:2fr 1fr 1fr;gap:18px;padding:22px 0}
    .legal{font-size:12px;color:#777}
    .notice{position:fixed;inset:auto 12px 12px 12px;background:#fff;border:1px solid #eee;border-radius:12px;padding:12px;display:flex;gap:12px;align-items:center;box-shadow:0 8px 16px rgba(0,0,0,.05)}
    .notice button{margin-left:auto}
    .cart-badge{display:inline-flex;align-items:center;gap:8px}
    .bubble{display:inline-grid;place-items:center;min-width:22px;height:22px;padding:0 6px;border-radius:999px;background:var(--brand);color:#fff;font-size:12px}

    /* Galleria immagini per articolo */
    .gallery{position:relative;background:#fff}
    .gallery-main{aspect-ratio: 4/3; width:100%; object-fit:cover}
    .thumbs{display:flex;gap:8px;padding:10px;overflow:auto;border-top:1px solid #f0f0f0}
    .thumbs img{width:56px;height:56px;object-fit:cover;border-radius:8px;border:2px solid transparent;cursor:pointer;flex:0 0 auto}
    .thumbs img.active{border-color:var(--brand)}

    /* Carrello */
    #carrello table{width:100%;border-collapse:collapse}
    #carrello th,#carrello td{padding:10px;border-bottom:1px solid #eee;text-align:left}
    #carrello .qty{width:68px;padding:8px;border:1px solid #ddd;border-radius:8px}
    #totali{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:14px}
    #totali .card{padding:14px}
    .right{text-align:right}

    @media (max-width:900px){.hero{grid-template-columns:1fr}.grid{grid-template-columns:1fr 1fr}.footercols{grid-template-columns:1fr 1fr}}
    @media (max-width:600px){.grid{grid-template-columns:1fr} #totali{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="wrap topbar">
      <div class="brand">
        <img src="logo.jpg" alt="Le creazioni di Dania" style="height:50px;border-radius:8px;object-fit:cover"/>
        <div>
          <div style="font-weight:700;color:var(--brand)">Le creazioni di Dania</div>
          <div style="font-size:12px;color:#7a7a7a">Cucito fatto a mano</div>
        </div>
      </div>
      <nav>
        <ul>
          <li><a href="#prodotti">Prodotti</a></li>
          <li><a href="#carrello" id="go-cart">Carrello <span class="bubble" id="cart-count">0</span></a></li>
        </ul>
      </nav>
      <div class="cart-badge">
        <a class="btn outline" href="#carrello">Vai al riepilogo</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="hero">
      <div>
        <span class="badge">100% fatto a mano in Italia</span>
        <h1>Le creazioni di Dania</h1>
        <p class="muted">Aggiungi i prodotti al carrello, rivedi il riepilogo e completa il pagamento in sicurezza.</p>
        <a href="#prodotti" class="btn">Sfoglia i prodotti</a>
      </div>
      <div>
        <img src="logo.jpg"/>
      </div>
    </section>

    <!-- PRODOTTI -->
    <section id="prodotti" class="section">
      <h2>In vetrina</h2>
      <div class="grid" id="product-grid"></div>
      <div class="banner" style="margin-top:16px">
        💡 <strong>Galleria foto</strong>: ogni articolo può avere più immagini. Clicca le miniatura per vederle. Aggiungi al carrello con la quantità desiderata.
      </div>
    </section>

    <!-- CARRELLO / RIEPILOGO -->
    <section id="carrello" class="section">
      <h2>Riepilogo ordine</h2>
      <div id="empty-cart" class="card" style="padding:16px;display:none">Il carrello è vuoto. Vai alla sezione <a href="#prodotti">Prodotti</a> per iniziare.</div>

      <div id="cart-wrap" style="display:none">
        <div class="card" style="padding:0">
          <div style="padding:10px 14px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center">
            <strong>I tuoi articoli</strong>
            <button id="clear-cart" class="btn outline" type="button">Svuota</button>
          </div>
          <div style="padding:10px 14px">
            <div style="overflow:auto">
              <table aria-label="Riepilogo carrello">
                <thead>
                  <tr>
                    <th>Articolo</th>
                    <th>Prezzo</th>
                    <th>Q.tà</th>
                    <th class="right">Subtotale</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="cart-tbody"></tbody>
              </table>
            </div>

            <div id="totali">
              <div class="card">
                <strong>Coupon</strong>
                <div style="display:flex;gap:8px;margin-top:8px">
                  <input id="coupon-input" placeholder="Codice sconto" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:10px"/>
                  <button id="apply-coupon" class="btn" type="button">Applica</button>
                </div>
                <small class="muted">Codice sconto di benvenuto : <code>WELCOME5</code> (−5%).</small>
                <div id="coupon-msg" class="muted" style="margin-top:8px"></div>
              </div>

              <div class="card">
                <strong>Totali</strong>
                <div style="display:grid;grid-template-columns:1fr auto;gap:6px;margin-top:8px">
                  <div class="muted">Subtotale</div><div class="right" id="subtot">€ 0,00</div>
                  <div class="muted">Sconto</div><div class="right" id="sconto">€ 0,00</div>
                  <div class="muted">Spedizione</div><div class="right" id="sped">€ 0,00</div>
                  <div style="border-top:1px dashed #e5e5e5;margin-top:6px"></div><div style="border-top:1px dashed #e5e5e5;margin-top:6px"></div>
                  <div><strong>Totale</strong></div><div class="right"><strong id="totale">€ 0,00</strong></div>
                </div>
                <div style="margin-top:10px" class="muted">Spedizione gratis sopra €59, altrimenti €6,90.</div>
              </div>
            </div>

            <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:14px">
              <button id="pay-paypal" class="btn" type="button">Paga con PayPal</button>
              <button id="pay-satispay" class="btn satispay" type="button">Paga con Satispay</button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="wrap footercols">
      <div>
        <div style="font-weight:700">Le creazioni di Dania</div>
        <p class="muted">Piccola sartoria artigianale con base in Italia. Ogni pezzo è cucito con cura, in tirature limitate.</p>
      </div>
      <div>
        <strong>Info</strong>
        <ul class="muted" style="list-style:none;padding:0;margin:8px 0 0;display:grid;gap:6px">
          <li><a href="#privacy" onclick="openModal('privacy-modal');return false;">Privacy</a></li>
          <li><a href="#termini" onclick="openModal('terms-modal');return false;">Termini</a></li>
          <li><a href="#cookie" onclick="openModal('cookie-modal');return false;">Cookie</a></li>
        </ul>
      </div>
      <div>
        <strong>Pagamenti</strong>
        <p class="muted">PayPal, Satispay, carte Visa/Mastercard (via PayPal). Bonifico su richiesta.</p>
      </div>
    </div>
    <div class="wrap legal">© <span id="year"></span> Le creazioni di Dania — P.IVA 00000000000 (esempio)</div>
  </footer>

  <!-- Modals -->
  <dialog id="privacy-modal" style="max-width:800px;width:90%">
    <h3>Privacy Policy (sintesi)</h3>
    <p>Raccogliamo i dati strettamente necessari per evadere gli ordini e rispondere alle richieste. Titolare del trattamento: [Tuo Nome], [indirizzo], email: dania.tiberi@gmail.com. Puoi richiedere accesso/cancellazione dei dati in ogni momento.</p>
    <button class="btn outline" onclick="closeModal('privacy-modal')">Chiudi</button>
  </dialog>
  <dialog id="terms-modal" style="max-width:800px;width:90%">
    <h3>Termini & Condizioni (sintesi)</h3>
    <p>Vendita di prodotti artigianali. Diritto di recesso entro 14 giorni eccetto articoli personalizzati. Garanzia legale di conformità. Prezzi in EUR, IVA inclusa ove applicabile.</p>
    <button class="btn outline" onclick="closeModal('terms-modal')">Chiudi</button>
  </dialog>
  <dialog id="cookie-modal" style="max-width:800px;width:90%">
    <h3>Cookie (sintesi)</h3>
    <p>Usiamo solo cookie tecnici essenziali per il funzionamento del sito. Nessun cookie di profilazione senza consenso.</p>
    <button class="btn outline" onclick="closeModal('cookie-modal')">Chiudi</button>
  </dialog>

  <dialog id="satispay-modal" style="max-width:560px;width:92%">
    <h3>Paga con Satispay</h3>
    <p class="muted">Scansiona il QR con l'app Satispay oppure apri direttamente l'app. Inserisci l'importo totale mostrato.</p>
    <p class="muted" style="margin-top:-6px"><strong>Intestatario:</strong> Dania Tiberi — <a href="tel:+393454895450">+39 345 489 5450</a></p>
    <div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap">
      <img id="satispay-qr" src="" alt="QR Satispay" style="width:220px;height:220px;border:1px solid #eee;border-radius:12px;padding:8px;background:#fff"/>
      <div>
        <div id="satispay-descr" class="muted" style="margin-bottom:10px"></div>
        <div style="font-weight:700">Totale: <span id="satispay-total"></span></div>
        <a id="satispay-open" href="#" target="_blank" rel="noopener" class="btn satispay">Apri Satispay</a>
        <button class="btn outline" onclick="closeModal('satispay-modal')" style="margin-left:8px">Chiudi</button>
      </div>
    </div>
  </dialog>

  <!-- Cookie notice -->
  <div class="notice" id="cookie-notice" role="dialog" aria-live="polite" aria-label="Informativa cookie" style="display:none">
    <div>🍪 Questo sito usa cookie tecnici per funzionare correttamente.</div>
    <button class="btn outline" onclick="acceptCookies()">Ok</button>
  </div>

  <script>
    // === CONFIG ===
    const paypalEmail = 'dania.tiberi@gmail.com';
    const paypalMerchantId = '';
    const paypalBusiness = paypalMerchantId || paypalEmail; // usa Merchant ID se disponibile
    const PAYPAL_PREFIX = 'Ordine Dania – ';

    const SHIPPING_FLAT = 6.90;
    const SHIPPING_FREE_THRESHOLD = 59.00;

    // Codici sconto: percentuale o fisso in €
    const COUPONS = [
      { code: 'DAN-10', type: 'percent', value: 10 },
      { code: 'WELCOME5', type:'percent', value: 5 },
      { code: 'EUR5', type: 'fixed', value: 5 },
    ];

    // Satispay: link pay-by-link del profilo business
    const satispayLink = 'https://satispay.me/daniatiberi';

    // --- Cookie notice
    const cn = document.getElementById('cookie-notice');
    if(!localStorage.getItem('cookie_ok')){cn.style.display='flex'}
    function acceptCookies(){localStorage.setItem('cookie_ok','1');cn.style.display='none'}

    // Footer year
    document.getElementById('year').textContent = new Date().getFullYear();

    function openModal(id){document.getElementById(id).showModal()} 
    function closeModal(id){document.getElementById(id).close()}

    // === DATI PRODOTTI (multi-foto supporto: images[]) ===
    const products = [
      {
        id: 'astuccio-pirati',
        name: 'Astuccio zip – Pirati',
        price: 15.0,
        images: ['astuccio.jpg','logo.jpg'],
        desc: 'Bustina piatta in cotone fantasia pirati con cerniera. Ideale per colori, giochi o piccoli accessori. Lavabile.',
        tag: 'Novità'
      },
      {
        id: 'porta-gioie-viaggio',
        name: 'Porta gioie da viaggi e accessori per capelli',
        price: 22.0,
        images: ['B.jpg','logo.jpg'],
        desc: 'Porta gioie da viaggi e accessori per capelli in tessuto doppia garza con inserto centrale in cotone fantasia. Lavabile.',
        tag: 'Bimbi'
      },
      {
        id: 'nata-per-sbuffare',
        name: 'Pochette “Nata per sbuffare”',
        price: 20.0,
        images: ['nata-per-sbuffare.jpg','logo.jpg'],
        desc: 'Pochette in cotone a righe verde/panna con ricamo “NATA PER SBUFFARE”, zip rossa e fodera interna. Lavabile.',
        tag: 'Best seller'
      },
      {
        id: 'nel-dubbio-polemizzo',
        name: 'Pochette “Nel dubbio polemizzo”',
        price: 20.0,
        images: ['nel-dubbio-polemizzo.jpg','logo.jpg'],
        desc: 'Pochette in cotone a righe grigio/panna con ricamo “NEL DUBBIO POLEMIZZO”, zip gialla e fodera interna. Lavabile.',
        tag: 'Fatto a mano'
      },
      {
        id: 'oggi-mordo-verde',
        name: 'Pochette “Oggi mordo” (verde)',
        price: 20.0,
        images: ['oggi-mordo.jpg','logo.jpg'],
        desc: 'Pochette in cotone a righe verde/panna con ricamo “OGGI MORDO”. Zip chiara e fodera interna. Lavabile.',
        tag: 'Fatto a mano'
      },
      {
        id: 'oggi-mordo-grigia',
        name: 'Pochette “Oggi mordo” (grigia)',
        price: 20.0,
        images: ['oggi-mordo2.jpg','logo.jpg'],
        desc: 'Pochette in cotone a righe grigio/panna con ricamo “OGGI MORDO”, zip rossa e fodera interna. Lavabile.',
        tag: 'Fatto a mano'
      },
      {
        id: 'porta-uncinetti',
        name: 'Porta gioie da viaggio e accessori capelli',
        price: 22.0,
        images: ['porta-uncinetti.jpg','logo.jpg'],
        desc: 'Organizer arrotolabile con tasca a zip e alloggi per utensili. Chiusura a bottone, pratico da viaggio. Lavabile.',
        tag: 'Novità'
      },
      {
        id: 'spazzolino-pirati',
        name: 'Porta spazzolino da viaggio – Pirati',
        price: 15.0,
        images: ['spazzolino.jpg'],
        desc: 'Astuccio portaspazzolino bimbi in cotone fantasia pirati: tre scomparti interni e chiusura con bottoni a pressione. Lavabile.',
        tag: 'Bimbi'
      },
      {
        id: 'spazzolino-compatto',
        name: 'Porta spazzolino – Variante compatta',
        price: 15.0,
        images: ['spazzolino1.jpg'],
        desc: 'Porta spazzolino compatto in tessuto fantasia con alloggi interni e chiusura a pressione. Perfetto da zaino. Lavabile.',
        tag: 'Bimbi'
      },
      {
        id: 'tonica-gin',
        name: 'Pochette “Tonica come il gin”',
        price: 20.0,
        images: ['tonica-come-il-gin.jpg'],
        desc: 'Pochette in cotone a righe grigio/panna con ricamo “TONICA (COME IL GIN)”. Zip rossa e pratico laccetto. Lavabile.',
        tag: 'Fatto a mano'
      }
    ];

    // === RENDER PRODOTTI (con galleria immagini) ===
    const grid = document.getElementById('product-grid');
    function renderProducts(){
      grid.innerHTML = '';
      products.forEach(p=>{
        const card = document.createElement('article');
        card.className='card';
        const firstImg = (p.images && p.images.length? p.images[0]: 'placeholder.jpg');
        card.innerHTML = `
          <div class="gallery">
            <img class="gallery-main" src="${firstImg}" alt="${p.name}" loading="lazy" decoding="async" />
            <div class="thumbs"></div>
          </div>
          <div class="body">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <strong>${p.name}</strong>
              <span class="pill">${p.tag||''}</span>
            </div>
            <div class="muted">${p.desc}</div>
            <div class="price">€ ${p.price.toFixed(2)}</div>
            <div class="actions" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
              <label class="muted" style="font-size:12px">Q.tà</label>
              <input type="number" class="qty" value="1" min="1" step="1" style="width:64px;padding:8px;border:1px solid #ddd;border-radius:8px">
              <button type="button" class="btn add-cart">Aggiungi al carrello</button>
            </div>
          </div>`;
        const thumbs = card.querySelector('.thumbs');
        const main = card.querySelector('.gallery-main');
        (p.images||[]).forEach((src,i)=>{
          const t = document.createElement('img');
          t.src = src; t.alt = p.name + ' miniatura ' + (i+1);
          if(i===0) t.classList.add('active');
          t.addEventListener('click',()=>{
            main.src = src;
            thumbs.querySelectorAll('img').forEach(el=>el.classList.remove('active'));
            t.classList.add('active');
          });
          thumbs.appendChild(t);
        });
        const qty = card.querySelector('.qty');
        card.querySelector('.add-cart').addEventListener('click',()=>{
          const q = Math.max(1, parseInt(qty.value||'1',10));
          addToCart(p.id, q);
        });
        grid.appendChild(card);
      });
    }

    // === CARRELLO (localStorage) ===
    const CART_KEY = 'cart-dania-v1';
    let cart = loadCart();

    function loadCart(){
      try{ return JSON.parse(localStorage.getItem(CART_KEY)) || {items:[], coupon:null}; }catch(e){ return {items:[], coupon:null}; }
    }
    function saveCart(){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); }

    function findProduct(id){ return products.find(p=>p.id===id); }

    function addToCart(id, qty){
      const item = cart.items.find(i=>i.id===id);
      if(item){ item.qty += qty; } else { cart.items.push({id, qty}); }
      saveCart();
      renderCart();
      flashCart();
    }

    function removeFromCart(id){
      cart.items = cart.items.filter(i=>i.id!==id);
      saveCart();
      renderCart();
    }

    function updateQty(id, qty){
      const it = cart.items.find(i=>i.id===id);
      if(it){ it.qty = Math.max(1, qty|0); saveCart(); renderCart(); }
    }

    function clearCart(){ cart = {items:[], coupon:null}; saveCart(); renderCart(); }

    function fmtEuro(n){ return '€ ' + n.toFixed(2).replace('.',','); }

    function computeTotals(){
      const lines = cart.items.map(i=>{
        const p = findProduct(i.id); return { id:i.id, name:p.name, price:p.price, qty:i.qty, subtotal: p.price*i.qty };
      });
      const subtotal = lines.reduce((s,l)=>s+l.subtotal,0);
      let discount = 0; let coupon = null;
      if(cart.coupon){
        coupon = COUPONS.find(c=>c.code.toUpperCase()===cart.coupon.toUpperCase());
        if(coupon){
          if(coupon.type==='percent') discount = subtotal * (coupon.value/100);
          if(coupon.type==='fixed') discount = Math.min(subtotal, coupon.value);
        }
      }
      const afterDisc = Math.max(0, subtotal - discount);
      const shipping = afterDisc >= SHIPPING_FREE_THRESHOLD || afterDisc===0 ? 0 : SHIPPING_FLAT;
      const total = afterDisc + shipping;
      return {lines, subtotal, discount, shipping, total, coupon};
    }

    function renderCart(){
      const {lines, subtotal, discount, shipping, total} = computeTotals();
      const count = cart.items.reduce((s,i)=>s+i.qty,0);
      document.getElementById('cart-count').textContent = count;

      const empty = document.getElementById('empty-cart');
      const wrap = document.getElementById('cart-wrap');
      empty.style.display = count? 'none':'block';
      wrap.style.display = count? 'block':'none';
      if(!count) return;

      const tb = document.getElementById('cart-tbody');
      tb.innerHTML = '';
      lines.forEach(l=>{
        const p = findProduct(l.id);
        const tr = document.createElement('tr');
        const thumb = (p.images&&p.images[0])||'placeholder.jpg';
        tr.innerHTML = `
          <td>
            <div style="display:flex;gap:10px;align-items:center">
              <img src="${thumb}" alt="${l.name}" style="width:54px;height:54px;object-fit:cover;border-radius:8px;border:1px solid #eee"/>
              <div>${l.name}</div>
            </div>
          </td>
          <td>${fmtEuro(l.price)}</td>
          <td>
            <input type="number" min="1" step="1" value="${l.qty}" class="qty" data-id="${l.id}" />
          </td>
          <td class="right">${fmtEuro(l.subtotal)}</td>
          <td class="right"><button class="btn outline rm" data-id="${l.id}">Rimuovi</button></td>
        `;
        tb.appendChild(tr);
      });

      // Bind qty & remove
      tb.querySelectorAll('input.qty').forEach(inp=>{
        inp.addEventListener('input',()=> updateQty(inp.dataset.id, Math.max(1, parseInt(inp.value||'1',10))) );
      });
      tb.querySelectorAll('button.rm').forEach(btn=>{
        btn.addEventListener('click',()=> removeFromCart(btn.dataset.id));
      });

      document.getElementById('subtot').textContent = fmtEuro(subtotal);
      document.getElementById('sconto').textContent = '− ' + fmtEuro(discount);
      document.getElementById('sped').textContent = shipping? fmtEuro(shipping): 'Gratis';
      document.getElementById('totale').textContent = fmtEuro(total);
    }

    function flashCart(){
      const el = document.getElementById('cart-count');
      el.animate([{transform:'scale(1)'},{transform:'scale(1.2)'},{transform:'scale(1)'}],{duration:400});
    }

    // Coupon handling
    document.addEventListener('click', (e)=>{
      if(e.target && e.target.id==='apply-coupon'){
        const code = (document.getElementById('coupon-input').value||'').trim();
        const msg = document.getElementById('coupon-msg');
        const found = COUPONS.find(c=>c.code.toUpperCase()===code.toUpperCase());
        if(found){ cart.coupon = code; saveCart(); msg.textContent = `Coupon applicato: ${found.type==='percent'? ('−'+found.value+'%'): ('−€ '+found.value)}`; renderCart(); }
        else { msg.textContent = 'Codice non valido.'; cart.coupon=null; saveCart(); renderCart(); }
      }
    });

    // Pulsanti carrello
    document.getElementById('clear-cart').addEventListener('click', clearCart);

    // PayPal checkout (carrello multi-riga)
    document.getElementById('pay-paypal').addEventListener('click', ()=>{
      const {lines, discount, shipping, coupon} = computeTotals();
      if(!lines.length) return;
      const f = document.createElement('form');
      f.action = 'https://www.paypal.com/cgi-bin/webscr';
      f.method = 'post';
      f.style.display = 'none';
      f.innerHTML = '';
      const fields = {
        cmd: '_cart', upload: '1', business: paypalBusiness, currency_code: 'EUR', charset: 'utf-8',
        custom: 'cart-' + Date.now()
      };
      Object.entries(fields).forEach(([k,v])=>{ const i=document.createElement('input'); i.type='hidden'; i.name=k; i.value=v; f.appendChild(i); });
      // linee
      lines.forEach((l,idx)=>{
        const n = idx+1;
        const map = {
          ['item_name_'+n]: PAYPAL_PREFIX + l.name,
          ['amount_'+n]: l.price.toFixed(2),
          ['quantity_'+n]: String(l.qty)
        };
        Object.entries(map).forEach(([k,v])=>{ const i=document.createElement('input'); i.type='hidden'; i.name=k; i.value=v; f.appendChild(i); });
      });
      // sconto su carrello
      if(coupon){
        if(coupon.type==='percent'){
          const i = document.createElement('input'); i.type='hidden'; i.name='discount_rate_cart'; i.value=String(coupon.value); f.appendChild(i);
        } else if(coupon.type==='fixed'){
          const i = document.createElement('input'); i.type='hidden'; i.name='discount_amount_cart'; i.value=discount.toFixed(2); f.appendChild(i);
        }
      }
      // spedizione come handling_cart
      if(shipping>0){ const i=document.createElement('input'); i.type='hidden'; i.name='handling_cart'; i.value=shipping.toFixed(2); f.appendChild(i); }

      document.body.appendChild(f);
      f.submit();
    });

    // Satispay checkout (mostra QR + totale)
    document.getElementById('pay-satispay').addEventListener('click', ()=>{
      const {lines, total} = computeTotals();
      if(!lines.length) return;
      const descr = lines.map(l=>`${l.name} x${l.qty}`).join(' • ');
      const qr = 'https://quickchart.io/qr?margin=2&size=220&text=' + encodeURIComponent(satispayLink);
      document.getElementById('satispay-qr').src = qr;
      document.getElementById('satispay-open').href = satispayLink;
      document.getElementById('satispay-descr').textContent = descr;
      document.getElementById('satispay-total').textContent = fmtEuro(total);
      openModal('satispay-modal');
    });

    // Navigazione
    document.getElementById('go-cart').addEventListener('click',()=> setTimeout(renderCart,0));

    // Init
    renderProducts();
    renderCart();
  </script>
  (function () {
  const form = document.getElementById('quote-form');
  const status = document.getElementById('form-status');
  if (!form || !status) return;
  form.addEventListener('submit', async (e) => {
    const phone = form.querySelector('input[name="telefono"]');
    const privacy = document.getElementById('privacy');
    const phoneErr = document.getElementById('phone-error');
    const privacyErr = document.getElementById('privacy-error');

    // Validazione Telefono (8-20 caratteri permessi + cifre/spazi/+/.())
    const raw = (phone?.value || '').trim();
    const ok = /^[0-9+().\s-]{8,20}$/.test(raw) && (raw.replace(/\D/g,'').length >= 8);
    if (!ok) {
      e.preventDefault();
      if (phoneErr) phoneErr.style.display = 'inline';
      if (privacyErr) privacyErr.style.display = 'none';
      phone?.focus();
      return;
    } else {
      if (phoneErr) phoneErr.style.display = 'none';
    }

    // Validazione Privacy obbligatoria
    if (!privacy?.checked) {
      e.preventDefault();
      if (privacyErr) privacyErr.style.display = 'inline';
      return;
    } else {
      if (privacyErr) privacyErr.style.display = 'none';
    }

    e.preventDefault();
    status.textContent = 'Invio in corso…';
    try {
      const res = await fetch(form.action, {
        method: 'POST',
        body: new FormData(form),
        headers: { 'Accept': 'application/json' }
      });
      if (res.ok) {
        window.location.href = 'grazie.html';
      } else {
        status.textContent = 'Ops, invio non riuscito. Riprova o scrivi a dania.tiberi@gmail.com.';
      }
    } catch (err) {
      status.textContent = 'Errore di rete. Controlla la connessione e riprova.';
    }
  });
})();
</script>
</body>
</html>
